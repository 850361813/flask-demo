<!DOCTYPE html>
<html style="height: 100%">
<head>
    <meta charset="utf-8">
</head>
<body style="height: 100%; margin: 0">
<br>
<br>
<h3>交易情况图表</h3>
<span style="color: green; ">业务日期:</span>
<input type="text" id="chooseDate" value="" onchange="refreshChart()">
<p>
    <button class="formerDay" onclick="minusDay()">上一日</button>
    <button class="latterDay" onclick="addDay()">下一日</button>
</p>

<div id="container" style="height: 100%"></div>
<script src="{{ url_for('static', filename='echarts.min.js') }}"></script>
<script src="{{ url_for('static', filename='echarts-gl.min.js') }}"></script>
<script src="{{ url_for('static', filename='jquery-3.3.1.min.js') }}"></script>

<script type="text/javascript">

    $(function () {
        var now = new Date('2018-01-01');
        var year = now.getFullYear();    //年
        var month = now.getMonth() + 1;   //月
        var day = now.getDate();
        document.getElementById("chooseDate").value = year + '-' + getFormatDate(month) + '-' + getFormatDate(day);
        refreshChart();
    });

    var dom = document.getElementById("container");
    var myChart = echarts.init(dom);
    option = null;
    var upColor = '#00da3c';
    var downColor = '#ec0000';

    function addDay() {
        var dateParam = document.getElementById("chooseDate").value;
        var date = new Date(dateParam);
        date.setDate(date.getDate() + 1);
        var month = date.getMonth() + 1;
        var day = date.getDate();
        var newDate = date.getFullYear() + '-' + getFormatDate(month) + '-' + getFormatDate(day);
        document.getElementById("chooseDate").value = newDate;
        refreshChart();
    }

    function minusDay() {
        var dateParam = document.getElementById("chooseDate").value;
        var date = new Date(dateParam);
        date.setDate(date.getDate() - 1);
        var month = date.getMonth() + 1;
        var day = date.getDate();
        var newDate = date.getFullYear() + '-' + getFormatDate(month) + '-' + getFormatDate(day);
        document.getElementById("chooseDate").value = newDate;
        refreshChart();
    }

    function refreshChart() {

        var dateVar = new Date(document.getElementById("chooseDate").value);

        var month = dateVar.getMonth() + 1;

        $.get('/download/' + pickFileName(month, getFormatDate(dateVar.getDate())), function (rawData) {

            var data = splitData(rawData);

            myChart.setOption(option = {
                backgroundColor: '#fff',
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['Dow-Jones index', 'MA5', 'MA10', 'MA20', 'MA30']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(245, 245, 245, 0.8)',
                    borderWidth: 1,
                    borderColor: '#ccc',
                    padding: 10,
                    textStyle: {
                        color: '#000'
                    },
                    position: function (pos, params, el, elRect, size) {
                        var obj = {top: 10};
                        obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 30;
                        return obj;
                    }
                },
                axisPointer: {
                    link: {xAxisIndex: 'all'},
                    label: {
                        backgroundColor: '#777'
                    }
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: false
                        },
                        brush: {
                            type: ['lineX', 'clear']
                        }
                    }
                },
                brush: {
                    xAxisIndex: 'all',
                    brushLink: 'all',
                    outOfBrush: {
                        colorAlpha: 0.1
                    }
                },
                visualMap: {
                    show: false,
                    seriesIndex: 5,
                    dimension: 2,
                    pieces: [{
                        value: 1,
                        color: downColor
                    }, {
                        value: -1,
                        color: upColor
                    }]
                },
                grid: [
                    {
                        left: '10%',
                        right: '8%',
                        height: '50%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '63%',
                        height: '16%'
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: data.categoryData,
                        scale: true,
                        boundaryGap: false,
                        axisLine: {onZero: false},
                        splitLine: {show: false},
                        splitNumber: 20,
                        min: 'dataMin',
                        max: 'dataMax',
                        axisPointer: {
                            z: 100
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: data.categoryData,
                        scale: true,
                        boundaryGap: false,
                        axisLine: {onZero: false},
                        axisTick: {show: false},
                        splitLine: {show: false},
                        axisLabel: {show: false},
                        splitNumber: 20,
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: {show: false},
                        axisLine: {show: false},
                        axisTick: {show: false},
                        splitLine: {show: false}
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 98,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1],
                        type: 'slider',
                        top: '85%',
                        start: 98,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: '交易',
                        type: 'line',
                        data: data.values,
                        smooth: true,
                        lineStyle: {
                            normal: {opacity: 0.5}
                        },

                        markPoint: {
                            symbol: 'diamond',
                            symbolSize: 20,
                            showDelay: 0,

                            itemStyle: {
                                normal: {
                                    label: {
                                        show: true,
                                        position: 'top',
                                        formatter: function (data) {
                                            if (data.values == 3872)
                                                return 'S';
                                            else
                                                return 'B';
                                        }
                                    }
                                }

                            },
                            {#data: [#}
                            {#    {name: '最高', value: 1, xAxis: '2013/2/18', yAxis: 2446},//通过yAxis来控制markPoint的位置#}
                            {#    {name: 'S', value: 1, xAxis: '2013/3/25', yAxis: 2344},#}
                            {#    {name: 'B', value: 0, xAxis: '2013/5/2', yAxis: 2176}#}
                            {#]#}
                        }
                    }
                ]
            }, true);


        });

        if (option && typeof option === "object") {
            myChart.setOption(option, true);
        }

    }

    function pickFileName(month, day) {
        return 'rb1805(' + month + '.' + day + ').csv'
    }

    function getFormatDate(arg) {

        if (arg == undefined || arg == '') {
            return '';
        }

        var re = arg + '';
        if (re.length < 2) {
            re = '0' + re;
        }

        return re;
    }

    function splitData(rawData) {
        var allRows = rawData.split(/\n/);
        var categoryData = [];
        var values = [];
        for (var i = 0; i < allRows.length; i++) {
            var day = allRows[i].split(',')[3];
            var ms = allRows[i].split(',')[4];
            categoryData.push(day + '.' + ms / 100);
            values.push(allRows[i].split(',')[5]);
        }

        return {
            categoryData: categoryData,
            values: values
        };
    }

</script>

</body>
</html>